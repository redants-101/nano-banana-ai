# 测试增强版退出功能

本文档详细说明如何测试新的增强版退出功能，包括 GitHub 和 Google 登录方式的退出。

## 功能概述

新的退出功能提供了以下增强特性：

1. **退出确认对话框** - 防止误操作
2. **特定提供商提示** - 显示从哪个账号（GitHub/Google）退出
3. **加载状态指示** - 退出过程中的视觉反馈
4. **成功提示** - 退出成功后的友好提示
5. **错误处理** - 优雅处理退出失败的情况
6. **完整清理** - 清除所有相关的 cookies 和本地存储

## 测试前准备

1. 确保项目正在运行：
   ```bash
   npm run dev
   ```

2. 确保已配置好 GitHub 和 Google OAuth（参见相关文档）

3. 打开浏览器开发者工具（F12），以便观察：
   - Console 日志
   - Network 请求
   - Application/Storage 标签页中的 Cookies 和 Local Storage

## 测试场景

### 场景 1：GitHub 账号退出测试

#### 步骤：

1. **登录 GitHub 账号**
   - 点击页面右上角的"登录"按钮
   - 选择"使用 GitHub 账号登录"
   - 完成 GitHub 授权流程
   - 确认登录成功，用户头像显示

2. **触发退出流程**
   - 点击用户头像打开下拉菜单
   - 点击"退出登录"选项

3. **验证确认对话框**
   - ✅ 应该弹出确认对话框
   - ✅ 对话框标题应显示："确认退出登录"
   - ✅ 对话框描述应提到"GitHub 账号"
   - ✅ 应该有"取消"和"确认退出"两个按钮

4. **测试取消操作**
   - 点击"取消"按钮
   - ✅ 对话框应该关闭
   - ✅ 用户仍保持登录状态

5. **执行退出操作**
   - 重新点击"退出登录"
   - 在确认对话框中点击"确认退出"
   - ✅ 按钮应显示加载状态（转圈图标+"退出中..."）
   - ✅ 取消和确认按钮应该被禁用

6. **验证退出成功**
   - ✅ 应显示成功 Toast 提示："退出成功 - 您已成功退出 GitHub 账号"
   - ✅ 页面自动跳转到首页
   - ✅ 右上角重新显示"登录"按钮
   - ✅ 用户头像消失

7. **检查清理情况**
   - 在开发者工具中检查：
   - ✅ 所有 `sb-` 开头的 cookies 应被清除
   - ✅ Local Storage 中的 `supabase.auth.token` 应被删除
   - ✅ Session Storage 应被清空

### 场景 2：Google 账号退出测试

#### 步骤：

1. **登录 Google 账号**
   - 点击"登录"按钮
   - 选择"使用 Google 账号登录"
   - 完成 Google 授权流程
   - 确认登录成功

2. **执行退出流程**
   - 重复上述 GitHub 退出测试的步骤 2-6
   - ✅ 确认对话框应提到"Google 账号"
   - ✅ 成功提示应显示"您已成功退出 Google 账号"

### 场景 3：错误处理测试

#### 模拟网络错误：

1. 登录任意账号
2. 打开开发者工具，切换到 Network 标签
3. 设置为 Offline 模式
4. 尝试退出登录
5. **验证**：
   - ✅ 应显示错误 Toast 提示
   - ✅ 错误提示应包含具体错误信息
   - ✅ 用户仍保持登录状态
   - ✅ 退出对话框应重新启用按钮

### 场景 4：快速连续操作测试

1. 登录账号
2. 快速连续点击退出按钮多次
3. **验证**：
   - ✅ 不应出现多个确认对话框
   - ✅ 退出过程中按钮应保持禁用状态
   - ✅ 不应发送重复的退出请求

### 场景 5：跨标签页同步测试

1. 在两个浏览器标签页中打开应用
2. 在两个标签页都登录同一账号
3. 在其中一个标签页执行退出
4. **验证**：
   - ✅ 退出操作完成后，另一个标签页刷新后也应显示未登录状态

## 服务器端日志验证

查看服务器控制台日志，应该包含：

```
User logout: user@example.com (Provider: github)
```
或
```
User logout: user@gmail.com (Provider: google)
```

## 性能指标

退出操作应该在以下时间内完成：

- 确认对话框响应：< 100ms
- 退出请求完成：< 1000ms
- 页面跳转：< 500ms

## 测试检查清单

### 基础功能
- [ ] GitHub 账号可以正常退出
- [ ] Google 账号可以正常退出
- [ ] 退出确认对话框正常显示
- [ ] 取消按钮功能正常
- [ ] 确认退出按钮功能正常

### UI/UX
- [ ] 加载状态正确显示
- [ ] 按钮在处理时正确禁用
- [ ] Toast 提示显示正确
- [ ] 提供商名称显示正确
- [ ] 页面跳转流畅

### 数据清理
- [ ] Cookies 被正确清除
- [ ] Local Storage 被正确清理
- [ ] Session Storage 被清空
- [ ] 用户状态正确更新

### 错误处理
- [ ] 网络错误时显示适当提示
- [ ] 服务器错误时显示适当提示
- [ ] 错误不会导致应用崩溃
- [ ] 错误后可以重试操作

### 边缘情况
- [ ] 快速点击不会导致问题
- [ ] 多标签页同步正常
- [ ] 刷新页面后状态正确

## 常见问题

### 1. Toast 提示不显示

**原因**：Toaster 组件未正确添加到布局中

**解决**：确认 `app/[locale]/layout.tsx` 中已添加 `<Toaster />` 组件

### 2. 退出后仍显示已登录

**原因**：客户端缓存未更新

**解决**：
- 确认 `router.refresh()` 被调用
- 检查是否有其他地方缓存了用户状态

### 3. 退出时间过长

**原因**：服务器响应慢或网络问题

**解决**：
- 检查网络连接
- 查看服务器日志是否有错误
- 确认 Supabase 服务正常

### 4. 提供商信息显示为 "unknown"

**原因**：用户元数据中没有提供商信息

**解决**：
- 检查 `user.app_metadata.provider` 字段
- 确认 Supabase 正确记录了提供商信息

## 相关文档

- [Google OAuth 设置指南](./GOOGLE_OAUTH_SETUP.md)
- [Supabase 配置指南](./SUPABASE_SETUP.md)
- [测试 Google 登录功能](./TESTING_GOOGLE_LOGIN.md)
