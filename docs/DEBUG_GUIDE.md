# 🔍 调试指南

## 刚刚修复的问题

之前的错误：`Cannot read properties of undefined (reading '0')`

### 已添加的改进

1. ✅ **安全的响应检查** - 在访问 `choices[0]` 前检查数组是否存在
2. ✅ **完整响应日志** - 打印 API 完整响应用于调试
3. ✅ **多种格式支持** - 支持不同的响应数据结构
4. ✅ **详细错误信息** - 提供更清晰的错误提示

## 🚀 如何测试

### 1. 重启开发服务器

```bash
# 停止当前服务器
Ctrl + C

# 重新启动
npm run dev
```

### 2. 打开浏览器开发者工具

1. 按 `F12` 打开开发者工具
2. 切换到 **Console（控制台）** 标签
3. 保持开发者工具打开状态

### 3. 测试图片上传和生成

1. 滚动到 "Try The AI Editor" 部分
2. 上传一张图片
3. 输入提示词，例如：
   ```
   请描述这张图片
   ```
4. 点击 "Generate Now"

### 4. 查看调试信息

在浏览器控制台中，您应该看到：

```
开始处理图片生成请求...
提示词: 请描述这张图片
API 完整响应: {
  // 这里会显示 API 返回的完整 JSON 数据
}
```

## 📋 可能的情况

### 情况 1: API 返回文本描述

如果 API 正常工作，您会看到：
```
生成成功: { role: 'assistant', content: '这张图片显示了...' }
```

**结果**：文本会显示在 Output Gallery

### 情况 2: API 返回图片

```
生成成功: { role: 'assistant', content: '', images: [...] }
检测到图片返回 (方式1): https://...
```

**结果**：图片会显示在 Output Gallery

### 情况 3: API 返回了但格式不同

```
API 完整响应: { ... }
```

**请复制这个完整响应，我可以帮您分析数据结构**

### 情况 4: API 调用失败

```
API 调用错误: [错误信息]
```

**可能的原因**：
- API Key 无效
- 网络连接问题
- 图片过大或格式不支持
- API 限流

## 🐛 常见错误及解决方案

### 错误 1: "API 返回了无效的响应"

**原因**：API 响应结构不符合预期

**解决方法**：
1. 查看控制台的完整响应日志
2. 复制日志内容给我分析
3. 检查 API Key 是否正确

### 错误 2: 网络错误

**症状**：
```
API 调用错误: fetch failed
```

**解决方法**：
1. 检查网络连接
2. 确认防火墙没有阻止请求
3. 尝试使用 VPN

### 错误 3: API Key 错误

**症状**：
```
API 调用错误: Invalid API key
```

**解决方法**：
1. 检查 `.env.local` 文件
2. 确认 API Key 没有多余空格
3. 重启开发服务器

### 错误 4: 图片太大

**症状**：
```
图片大小不能超过 10MB
```

**解决方法**：
1. 使用图片压缩工具
2. 选择尺寸更小的图片

## 📊 查看网络请求详情

### 在开发者工具中

1. 切换到 **Network（网络）** 标签
2. 点击 "Generate Now" 按钮
3. 找到 `generate-image` 请求
4. 点击查看详情：
   - **Headers** - 查看请求头
   - **Payload** - 查看发送的数据
   - **Response** - 查看返回的数据
   - **Preview** - 预览返回的 JSON

### 检查请求数据

**Request Payload** 应该包含：
```json
{
  "imageUrl": "data:image/jpeg;base64,...",
  "prompt": "请描述这张图片"
}
```

### 检查响应数据

**Response** 应该返回：
```json
{
  "success": true,
  "result": "图片描述...",
  "imageUrl": null,
  "message": "图片处理成功！",
  "debug": {
    "hasContent": true,
    "hasImage": false
  }
}
```

## 🔧 终端日志位置

如果运行 `npm run dev`，查看命令行窗口：

```
开始处理图片生成请求...
提示词: xxx
API 完整响应: {...}
生成成功: {...}
```

## 💡 下一步

如果仍然有问题：

1. **复制完整的错误日志**
   - 浏览器控制台的错误
   - 终端的错误日志

2. **复制 API 完整响应**
   - 在控制台找到 "API 完整响应:" 这一行
   - 复制整个 JSON 对象

3. **告诉我测试详情**
   - 使用的提示词
   - 上传的图片类型和大小
   - 完整的错误信息

这样我就能帮您精确定位问题！

## ✅ 预期结果

成功的流程应该是：

1. ✅ 上传图片 → 显示预览
2. ✅ 输入提示词 → 启用生成按钮
3. ✅ 点击生成 → 显示"生成中..."
4. ✅ API 调用成功 → 显示结果
5. ✅ 可以查看/复制/下载结果

如果每一步都成功，您就可以正常使用 AI 图片编辑功能了！
