<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’³ æ”¯ä»˜æ¨¡å—å®Œæ•´è¯Šæ–­å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            padding: 30px;
        }

        .section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .section h2 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section p {
            color: #6c757d;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: #6c757d;
        }

        button.success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
        }

        button.danger {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }

        .result {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .result pre {
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            color: #212529;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin: 2px;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .info-card h4 {
            color: #495057;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .info-card p {
            color: #6c757d;
            font-size: 13px;
            margin: 0;
        }

        .code-block {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            overflow-x: auto;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e9ecef;
        }

        .tab {
            padding: 10px 20px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’³ æ”¯ä»˜æ¨¡å—å®Œæ•´è¯Šæ–­å·¥å…·</h1>
            <p>Nano Banana AI - Payment Module Diagnostic Tool</p>
        </div>

        <div class="content">
            <!-- å¿«é€Ÿè¯Šæ–­ -->
            <div class="section">
                <h2>ğŸš€ å¿«é€Ÿè¯Šæ–­</h2>
                <p>ä¸€é”®æ£€æŸ¥æ‰€æœ‰å…³é”®é…ç½®å’Œ API ç«¯ç‚¹çŠ¶æ€</p>
                <div class="button-group">
                    <button onclick="runFullDiagnostic()" class="success">ğŸ” è¿è¡Œå®Œæ•´è¯Šæ–­</button>
                    <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
                </div>
                <div id="diagnostic-result" class="result" style="display: none;"></div>
            </div>

            <!-- ç¯å¢ƒå˜é‡æ£€æŸ¥ -->
            <div class="section">
                <h2>âš™ï¸ ç¯å¢ƒå˜é‡æ£€æŸ¥</h2>
                <p>æ£€æŸ¥æ‰€æœ‰å¿…éœ€å’Œå¯é€‰çš„ç¯å¢ƒå˜é‡é…ç½®çŠ¶æ€</p>
                <div class="button-group">
                    <button onclick="checkEnvVars()">æ£€æŸ¥ç¯å¢ƒå˜é‡</button>
                </div>
                <div id="env-result" class="result" style="display: none;"></div>
            </div>

            <!-- API è·¯ç”±æµ‹è¯• -->
            <div class="section">
                <h2>ğŸ”Œ API è·¯ç”±æµ‹è¯•</h2>
                <p>æµ‹è¯•ä¸åŒæ–¹å¼è°ƒç”¨ API çš„ç»“æœï¼Œè¯Šæ–­è·¯ç”±é—®é¢˜</p>
                
                <div class="info-grid">
                    <div class="info-card">
                        <h4>å½“å‰é¡µé¢ä¿¡æ¯</h4>
                        <p><strong>Origin:</strong> <span id="current-origin"></span></p>
                        <p><strong>Pathname:</strong> <span id="current-pathname"></span></p>
                    </div>
                    <div class="info-card">
                        <h4>API åŸºç¡€è·¯å¾„</h4>
                        <p><strong>Absolute:</strong> /api/creem/create-checkout</p>
                        <p><strong>With Origin:</strong> {origin}/api/...</p>
                    </div>
                </div>

                <div class="button-group">
                    <button onclick="testHealthCheck()">1ï¸âƒ£ å¥åº·æ£€æŸ¥</button>
                    <button onclick="testRelativePath()">2ï¸âƒ£ ç›¸å¯¹è·¯å¾„</button>
                    <button onclick="testAbsolutePath()">3ï¸âƒ£ ç»å¯¹è·¯å¾„</button>
                    <button onclick="testOriginPath()">4ï¸âƒ£ Origin è·¯å¾„</button>
                </div>
                <div id="api-result" class="result" style="display: none;"></div>
            </div>

            <!-- æ”¯ä»˜æµç¨‹æµ‹è¯• -->
            <div class="section">
                <h2>ğŸ’° æ”¯ä»˜æµç¨‹æµ‹è¯•</h2>
                <p>æ¨¡æ‹ŸçœŸå®æ”¯ä»˜æµç¨‹ï¼Œæµ‹è¯• Creem API é›†æˆ</p>
                <div class="button-group">
                    <button onclick="testPaymentFlow('monthly')">æµ‹è¯•æœˆä»˜è®¢é˜…</button>
                    <button onclick="testPaymentFlow('yearly')">æµ‹è¯•å¹´ä»˜è®¢é˜…</button>
                </div>
                <div id="payment-result" class="result" style="display: none;"></div>
            </div>

            <!-- è§£å†³æ–¹æ¡ˆæŒ‡å— -->
            <div class="section">
                <h2>ğŸ“– å¸¸è§é—®é¢˜è§£å†³æ–¹æ¡ˆ</h2>
                <p>æ ¹æ®è¯Šæ–­ç»“æœï¼Œè¿™é‡Œæ˜¯å¸¸è§é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼š</p>
                
                <details style="margin-top: 15px;">
                    <summary style="cursor: pointer; font-weight: 600; padding: 10px; background: white; border-radius: 5px;">âŒ 404 Not Found</summary>
                    <div class="code-block" style="margin-top: 10px;">
<strong>é—®é¢˜ï¼š</strong>API è·¯ç”±è¿”å› 404 é”™è¯¯

<strong>åŸå› ï¼š</strong>
1. ç›¸å¯¹è·¯å¾„åœ¨å›½é™…åŒ–è·¯ç”±ä¸­è¢«é”™è¯¯è§£æ
2. API è·¯ç”±æ–‡ä»¶ä½ç½®ä¸æ­£ç¡®
3. Middleware é…ç½®æ‹¦æˆªäº† API è¯·æ±‚

<strong>è§£å†³æ–¹æ¡ˆï¼š</strong>
1. ä½¿ç”¨ window.location.origin æ‹¼æ¥å®Œæ•´ URLï¼š
   const url = `${window.location.origin}/api/creem/create-checkout`

2. æ£€æŸ¥æ–‡ä»¶ä½ç½®ï¼š
   app/api/creem/create-checkout/route.ts

3. æ£€æŸ¥ middleware.ts é…ç½®ï¼š
   matcher: ['/((?!api|...)...)']
                    </div>
                </details>

                <details style="margin-top: 10px;">
                    <summary style="cursor: pointer; font-weight: 600; padding: 10px; background: white; border-radius: 5px;">âš™ï¸ ç¯å¢ƒå˜é‡æœªé…ç½®</summary>
                    <div class="code-block" style="margin-top: 10px;">
<strong>é—®é¢˜ï¼š</strong>CREEM_API_KEY æˆ–å…¶ä»–ç¯å¢ƒå˜é‡æœªé…ç½®

<strong>è§£å†³æ–¹æ¡ˆï¼š</strong>
1. åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º .env.local æ–‡ä»¶
2. æ·»åŠ å¿…éœ€çš„ç¯å¢ƒå˜é‡ï¼š

CREEM_API_KEY=your-api-key
NEXT_PUBLIC_CREEM_PRO_PRODUCT_ID=prod_xxxx

3. é‡å¯å¼€å‘æœåŠ¡å™¨ï¼ˆCtrl+C ç„¶å npm run devï¼‰
4. å†æ¬¡è¿è¡Œè¯Šæ–­å·¥å…·éªŒè¯
                    </div>
                </details>

                <details style="margin-top: 10px;">
                    <summary style="cursor: pointer; font-weight: 600; padding: 10px; background: white; border-radius: 5px;">ğŸ” API è®¤è¯å¤±è´¥</summary>
                    <div class="code-block" style="margin-top: 10px;">
<strong>é—®é¢˜ï¼š</strong>Creem API è¿”å› 401 Unauthorized

<strong>è§£å†³æ–¹æ¡ˆï¼š</strong>
1. æ£€æŸ¥ CREEM_API_KEY æ˜¯å¦æ­£ç¡®
2. ç™»å½• Creem Dashboard éªŒè¯ API Key
3. ç¡®ä¿ API Key æœ‰è¶³å¤Ÿçš„æƒé™
4. æ£€æŸ¥ API Key æ˜¯å¦è¿‡æœŸ
                    </div>
                </details>
            </div>
        </div>
    </div>

    <script>
        // æ˜¾ç¤ºå½“å‰é¡µé¢ä¿¡æ¯
        document.getElementById('current-origin').textContent = window.location.origin;
        document.getElementById('current-pathname').textContent = window.location.pathname;

        function showResult(elementId, content, autoShow = true) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<pre>${JSON.stringify(content, null, 2)}</pre>`;
            if (autoShow) {
                element.style.display = 'block';
            }
        }

        function clearResults() {
            ['diagnostic-result', 'env-result', 'api-result', 'payment-result'].forEach(id => {
                document.getElementById(id).style.display = 'none';
                document.getElementById(id).innerHTML = '';
            });
        }

        async function runFullDiagnostic() {
            const result = {
                timestamp: new Date().toISOString(),
                tests: []
            };

            showResult('diagnostic-result', { status: 'â³ æ­£åœ¨è¿è¡Œå®Œæ•´è¯Šæ–­...' });

            // æµ‹è¯• 1: å¥åº·æ£€æŸ¥
            try {
                const healthResponse = await fetch('/api/health-check');
                result.tests.push({
                    name: 'å¥åº·æ£€æŸ¥',
                    status: healthResponse.ok ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥',
                    statusCode: healthResponse.status
                });
            } catch (error) {
                result.tests.push({
                    name: 'å¥åº·æ£€æŸ¥',
                    status: 'âŒ å¤±è´¥',
                    error: error.message
                });
            }

            // æµ‹è¯• 2: ç¯å¢ƒå˜é‡æ£€æŸ¥
            try {
                const envResponse = await fetch('/api/check-env');
                const envData = await envResponse.json();
                result.tests.push({
                    name: 'ç¯å¢ƒå˜é‡æ£€æŸ¥',
                    status: envData.summary.status,
                    configured: `${envData.summary.configured}/${envData.summary.total}`,
                    recommendations: envData.recommendations
                });
            } catch (error) {
                result.tests.push({
                    name: 'ç¯å¢ƒå˜é‡æ£€æŸ¥',
                    status: 'âŒ å¤±è´¥',
                    error: error.message
                });
            }

            // æµ‹è¯• 3: API è·¯ç”±æµ‹è¯•
            try {
                const apiUrl = `${window.location.origin}/api/creem/create-checkout`;
                const apiResponse = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: 'test_product',
                        billingCycle: 'monthly'
                    })
                });
                result.tests.push({
                    name: 'API è·¯ç”±æµ‹è¯•',
                    status: apiResponse.status === 200 || apiResponse.status === 400 || apiResponse.status === 500 ? 'âœ… è·¯ç”±æ­£å¸¸' : 'âŒ è·¯ç”±å¼‚å¸¸',
                    statusCode: apiResponse.status,
                    note: apiResponse.status === 500 ? 'è·¯ç”±æ­£å¸¸ï¼Œä½†å¯èƒ½ç¼ºå°‘ Creem é…ç½®' : ''
                });
            } catch (error) {
                result.tests.push({
                    name: 'API è·¯ç”±æµ‹è¯•',
                    status: 'âŒ å¤±è´¥',
                    error: error.message
                });
            }

            // æ±‡æ€»ç»“æœ
            const passedTests = result.tests.filter(t => t.status.includes('âœ…')).length;
            result.summary = {
                total: result.tests.length,
                passed: passedTests,
                failed: result.tests.length - passedTests,
                overallStatus: passedTests === result.tests.length ? 'âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡' : 'âš ï¸ éƒ¨åˆ†æµ‹è¯•æœªé€šè¿‡'
            };

            showResult('diagnostic-result', result);
        }

        async function checkEnvVars() {
            try {
                showResult('env-result', { status: 'â³ æ­£åœ¨æ£€æŸ¥ç¯å¢ƒå˜é‡...' });
                
                const response = await fetch('/api/check-env');
                const data = await response.json();
                
                showResult('env-result', data);
            } catch (error) {
                showResult('env-result', {
                    error: 'æ£€æŸ¥å¤±è´¥',
                    message: error.message,
                    suggestion: 'è¯·ç¡®ä¿å¼€å‘æœåŠ¡å™¨æ­£åœ¨è¿è¡Œ'
                });
            }
        }

        async function testHealthCheck() {
            try {
                showResult('api-result', { status: 'â³ æ­£åœ¨æµ‹è¯•...' });
                
                const response = await fetch('/api/health-check');
                const data = await response.json();
                
                showResult('api-result', {
                    test: 'å¥åº·æ£€æŸ¥',
                    url: '/api/health-check',
                    status: response.status,
                    ok: response.ok,
                    data: data
                });
            } catch (error) {
                showResult('api-result', {
                    test: 'å¥åº·æ£€æŸ¥',
                    error: error.message
                });
            }
        }

        async function testRelativePath() {
            try {
                showResult('api-result', { status: 'â³ æ­£åœ¨æµ‹è¯•ç›¸å¯¹è·¯å¾„...' });
                
                const url = '/api/creem/create-checkout';
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: 'test_product',
                        billingCycle: 'monthly'
                    })
                });
                
                const data = await response.json();
                
                showResult('api-result', {
                    test: 'ç›¸å¯¹è·¯å¾„æµ‹è¯•',
                    url: url,
                    currentPath: window.location.pathname,
                    actualUrl: `å½“å‰è·¯å¾„: ${window.location.pathname}, å¯èƒ½è§£æä¸º: ${window.location.pathname}/api/creem/create-checkout`,
                    status: response.status,
                    ok: response.ok,
                    data: data
                });
            } catch (error) {
                showResult('api-result', {
                    test: 'ç›¸å¯¹è·¯å¾„æµ‹è¯•',
                    error: error.message
                });
            }
        }

        async function testAbsolutePath() {
            try {
                showResult('api-result', { status: 'â³ æ­£åœ¨æµ‹è¯•ç»å¯¹è·¯å¾„...' });
                
                const url = 'http://localhost:3000/api/creem/create-checkout';
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: 'test_product',
                        billingCycle: 'monthly'
                    })
                });
                
                const data = await response.json();
                
                showResult('api-result', {
                    test: 'ç»å¯¹è·¯å¾„æµ‹è¯•',
                    url: url,
                    status: response.status,
                    ok: response.ok,
                    data: data
                });
            } catch (error) {
                showResult('api-result', {
                    test: 'ç»å¯¹è·¯å¾„æµ‹è¯•',
                    error: error.message
                });
            }
        }

        async function testOriginPath() {
            try {
                showResult('api-result', { status: 'â³ æ­£åœ¨æµ‹è¯• Origin è·¯å¾„...' });
                
                const url = `${window.location.origin}/api/creem/create-checkout`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: 'test_product',
                        billingCycle: 'monthly'
                    })
                });
                
                const data = await response.json();
                
                showResult('api-result', {
                    test: 'Origin è·¯å¾„æµ‹è¯•ï¼ˆæ¨èæ–¹å¼ï¼‰',
                    url: url,
                    windowOrigin: window.location.origin,
                    status: response.status,
                    ok: response.ok,
                    data: data,
                    recommendation: 'âœ… è¿™æ˜¯æ¨èçš„è°ƒç”¨æ–¹å¼'
                });
            } catch (error) {
                showResult('api-result', {
                    test: 'Origin è·¯å¾„æµ‹è¯•',
                    error: error.message
                });
            }
        }

        async function testPaymentFlow(billingCycle) {
            try {
                showResult('payment-result', { status: `â³ æ­£åœ¨æµ‹è¯•${billingCycle === 'monthly' ? 'æœˆä»˜' : 'å¹´ä»˜'}è®¢é˜…...` });
                
                const url = `${window.location.origin}/api/creem/create-checkout`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        productId: 'test_product_id',
                        billingCycle: billingCycle
                    })
                });
                
                const data = await response.json();
                
                showResult('payment-result', {
                    test: `æ”¯ä»˜æµç¨‹æµ‹è¯• - ${billingCycle === 'monthly' ? 'æœˆä»˜' : 'å¹´ä»˜'}`,
                    billingCycle: billingCycle,
                    status: response.status,
                    ok: response.ok,
                    data: data,
                    note: data.checkoutUrl ? 'âœ… æˆåŠŸè·å–æ”¯ä»˜é“¾æ¥' : 'âš ï¸ æœªè·å–åˆ°æ”¯ä»˜é“¾æ¥ï¼Œè¯·æ£€æŸ¥ Creem é…ç½®'
                });
            } catch (error) {
                showResult('payment-result', {
                    test: 'æ”¯ä»˜æµç¨‹æµ‹è¯•',
                    error: error.message
                });
            }
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºå½“å‰é…ç½®
        window.addEventListener('load', () => {
            console.log('ğŸ’³ æ”¯ä»˜æ¨¡å—è¯Šæ–­å·¥å…·å·²åŠ è½½');
            console.log('å½“å‰é¡µé¢:', window.location.href);
            console.log('Origin:', window.location.origin);
        });
    </script>
</body>
</html>

